(globalThis.webpackChunkjupyhai=globalThis.webpackChunkjupyhai||[]).push([[70],{5070:(e,t,n)=>{"use strict";n.r(t),n.d(t,{default:()=>fe});var a=n(2634),o=n(9169),r=n(3992),i=n(6271),s=n.n(i),c=n(4456);const l=(e,t)=>e===t,u={};var d=n(6760),g=n.n(d);function p(e,t){const n=e.endsWith("/")?"":"/";return e+n+(t?t.replace(/^\/+/,""):"")}function m(){let e=window.location.origin;const t=document.body;if(t){const n=t.getAttribute("data-base-url");n&&(e=p(e,n))}return e}const f=p(m(),"jupyhai"),h=g().create({baseURL:f,xsrfCookieName:"_xsrf",xsrfHeaderName:"X-XSRFToken"}),v=h;async function y(e){return(await h.get(e)).data}var E;async function b(e){const t={project_id:e.configuration.projectId||"",environment_id:e.configuration.environmentId||"",title:e.configuration.title||"",image:e.configuration.image||"",ignore:e.configuration.ignore||"",mounts:e.configuration.mounts||[]};await v.post("/settings",t)}!function(e){e[e.LoggedOut=0]="LoggedOut",e[e.LoggedIn=1]="LoggedIn",e[e.LoggingIn=2]="LoggingIn"}(E||(E={}));const x={loginStatus:E.LoggedOut,loginError:void 0,notebookInstanceId:void 0,hostFlavor:void 0,username:void 0,defaultHost:void 0,preparingExecutionCounter:0,preparingExecutionEvents:[],preparingExecutionFailed:!1,executionsFetched:!1,executions:{},executionEvents:{},configuration:{projectId:void 0,environmentId:void 0,image:"",title:"",ignore:[],mounts:[]}};function j(e,t){switch(t.type){case"loadPersistedState":{const{persistedState:n}=t;return function(e,t,n){let a=t;return n.forEach((t=>{null!==t&&(a=e(a,t))})),a}(j,e,[n.loginStatus===E.LoggedIn&&n.hostFlavor?{type:"loginSuccess",hostFlavor:n.hostFlavor,username:n.username}:null,n.configuration?{type:"changeConfiguration",configuration:n.configuration}:null,n.defaultHost?{type:"changeDefaultHost",defaultHost:n.defaultHost}:null])}case"logout":return Object.assign(Object.assign({},e),{executions:{},executionEvents:{},executionsFetched:!1,preparingExecutionCounter:0,preparingExecutionEvents:[],preparingExecutionFailed:!1,hostFlavor:void 0,loginStatus:E.LoggedOut,loginError:void 0,username:void 0});case"loginAttemptStarted":return Object.assign(Object.assign({},e),{hostFlavor:void 0,loginStatus:E.LoggingIn});case"loginSuccess":return Object.assign(Object.assign({},e),{executions:{},executionEvents:{},executionsFetched:!1,preparingExecutionCounter:0,preparingExecutionEvents:[],preparingExecutionFailed:!1,hostFlavor:t.hostFlavor,loginStatus:E.LoggedIn,loginError:void 0,username:t.username});case"loginFailed":return Object.assign(Object.assign({},e),{loginStatus:E.LoggedOut,loginError:t.error});case"changeProject":{const n=Object.assign(Object.assign({},e),{executions:{},executionEvents:{},executionsFetched:!1,preparingExecutionCounter:0,preparingExecutionEvents:[],preparingExecutionFailed:!1,configuration:Object.assign(Object.assign({},e.configuration),{projectId:t.projectId})});return b(n),n}case"changeConfiguration":{const n=Object.assign(Object.assign({},e),{configuration:t.configuration});return b(n),n}case"changeDefaultHost":return Object.assign(Object.assign({},e),{defaultHost:t.defaultHost});case"startPreparingExecution":return Object.assign(Object.assign({},e),{preparingExecutionEvents:[],preparingExecutionCounter:t.currentMaxCounter+1,preparingExecutionFailed:!1});case"addPreparingExecutionEvent":return Object.assign(Object.assign({},e),{preparingExecutionEvents:[...e.preparingExecutionEvents,t.event]});case"preparingExecutionFailed":return Object.assign(Object.assign({},e),{preparingExecutionFailed:!0});case"executionsFetched":return Object.assign(Object.assign({},e),{executionsFetched:!0});case"updateExecution":if(t.projectId===e.configuration.projectId){const{id:n}=t.execution;return Object.assign(Object.assign({},e),{executions:Object.assign(Object.assign({},e.executions),{[n]:t.execution})})}return e;case"updateExecutionEvents":{const{id:n}=t;return Object.assign(Object.assign({},e),{executionEvents:Object.assign(Object.assign({},e.executionEvents),{[n]:t.events})})}default:throw new Error}}const w=e=>{O.set((t=>j(t,e)))},O=function(e,t){let n=[],a=e;function o(e,o){const r=a;a=e instanceof Function?e(a):e,setTimeout((()=>{var e;n.forEach((e=>e(a))),null==o||o(a),null===(e=void 0)||void 0===e||e.call(t,a,r)}))}function r(e){return n.push(e),()=>{n=n.filter((t=>t!==e))}}function s(){const[e,t]=(0,i.useState)(a);var n;return n=t,(0,i.useLayoutEffect)((()=>r(n)),[n]),[e,o]}return{use:s,useSelector:function(e,t=l){const[n]=s();return function(e,t=l){const n=(0,i.useRef)(u);let a=n.current;return(0,i.useLayoutEffect)((()=>{n.current=a})),n.current!==u&&t(e,n.current)||(a=e),a}(e(n),t)},useValue:()=>s()[0],get:()=>a,set:o,reset:()=>o(e),subscribe:r}}(x),k=()=>O.useValue(),C=()=>w;var S;function N(e,t){window.dispatchEvent(new CustomEvent(e,{detail:t}))}!function(e){e.Execute="jupyhai_execute",e.ShowSettings="jupyhai_show_settings",e.ShowLogs="jupyhai_show_logs"}(S||(S={}));var I=n(3195),L=n.n(I);function F(e){return Object.values(e).reduce(((e,{counter:t})=>Math.max(t,e)),0)}function P(e){return"complete"===(t=e.status)||"error"===t||"stopped"===t;var t}var A=n(5106);const R=({items:e})=>{const t=s().useRef(null),[n,a]=s().useState(!0),o=s().useCallback((()=>{a(!1)}),[]),r=s().useCallback((e=>{a(e.target.checked)}),[]);return s().useLayoutEffect((()=>{n&&t.current&&t.current.scrollTo(0,Number.MAX_SAFE_INTEGER)}),[n,e.length]),s().createElement(s().Fragment,null,s().createElement("div",{className:"jupyhai-console-output",ref:t,onWheel:o},e.map((e=>{let t;switch(e.stream){case"stderr":t="jupyhai-console-warning";break;case"status":t="jupyhai-console-info";break;default:t=""}return s().createElement("div",{className:t,key:`${e.time}${e.stream||""}${e.message}`},e.message)}))),s().createElement("label",{style:{paddingLeft:"10px"}},s().createElement("input",{type:"checkbox",checked:n,onChange:r})," Autoscroll"))};function _({events:e}){const[t,n]=s().useState(0);(0,A.useInterval)((()=>n((e=>e+1))),1e3);const a=s().useMemo((()=>void 0===e?null:(e||[]).filter((e=>e.message.length>0))),[e]);return a?a.length?s().createElement(R,{items:a}):s().createElement("div",{className:"jupyhai-console-output"},"Execution has not generated any output yet."):s().createElement("div",{className:"jupyhai-console-output"},function(e,t){let n=".";for(let e=0;e<(t+2)%3;e++)n+=".";return`loading${n}`}(0,t))}var $=n(1572),M=n.n($);const T=({executionId:e})=>{const t=k(),{executions:n}=t,a=function(e,t){var n,a;const o=`/events/${e}`;return null!==(a=null===(n=M()(`/events/${e}`,(async()=>(await v.get(o)).data),t).data)||void 0===n?void 0:n.results)&&void 0!==a?a:void 0}(e,{refreshInterval:e in n&&P(n[e])?2500:1500});return i.createElement(_,{events:a})};var J=n(5923);class H{createNew(e,t){const n=new o.ToolbarButton({className:"run-remote-button",label:"Run Remote",onClick:()=>{const n={json:t.model.toJSON(),path:e.context.sessionContext.path,save:()=>{t.createCheckpoint()}};N(S.Execute,n)},tooltip:"Run Remote"});return e.toolbar.insertItem(10,"runRemote",n),new J.DisposableDelegate((()=>{n.dispose()}))}}var V=n(6662),D=n(1700),U=n.n(D);const W=({visible:e,className:t,style:n})=>e?s().createElement("img",{className:`jupyhai-spinner ${t||""}`,alt:"Loading",style:n}):null;n(2735);var z=n(2184),X=n.n(z);s().forwardRef(((e,t)=>{var{className:n,children:a}=e,o=function(e,t){var n={};for(var a in e)Object.prototype.hasOwnProperty.call(e,a)&&t.indexOf(a)<0&&(n[a]=e[a]);if(null!=e&&"function"==typeof Object.getOwnPropertySymbols){var o=0;for(a=Object.getOwnPropertySymbols(e);o<a.length;o++)t.indexOf(a[o])<0&&Object.prototype.propertyIsEnumerable.call(e,a[o])&&(n[a[o]]=e[a[o]])}return n}(e,["className","children"]);return s().createElement("div",Object.assign({ref:t,role:"tooltip"},o,{className:X()("tooltip",n)}),s().createElement("div",{className:"tooltip-arrow"}),s().createElement("div",{className:"tooltip-inner"},a))})),g().create({baseURL:p(m(),"api"),xsrfCookieName:"_xsrf",xsrfHeaderName:"X-XSRFToken"});const B={complete:"fa-check-circle",error:"fa-exclamation-circle",stopped:"fa-stop",stopping:"fa-pause",started:"fa-play",created:"fa-ellipsis-h",queued:"fa-circle",preparing:"fa-circle",failed:"fa-circle"};var G=n(5889);const q=new(n.n(G)())({concurrency:2});const K=({execution:e})=>i.createElement("tr",null,i.createElement("td",null,e.counter),i.createElement("td",null,i.createElement("span",{className:`jupyhai-execution-text-${e.status}`},i.createElement("i",{className:`fa ${B[e.status]||""}`,style:{display:"inline"}}),"Â ",U()(e.status))),i.createElement("td",null,(0,V.formatDistanceToNow)((0,V.parseISO)(e.ctime)).replace("months","mo")," ago"),i.createElement("td",null,e.duration),i.createElement("td",null,i.createElement("button",{type:"button",className:"jupyhai-button",onClick:()=>(e=>{const t=new CustomEvent(S.ShowLogs,{detail:e});window.dispatchEvent(t)})({counter:e.counter,id:e.id})},"Logs"),i.createElement("button",{type:"button",className:"jupyhai-button",onClick:async()=>async function(e,t){let n=`${e.urls.display}${t}`;const a=await v.get(`/execution-url-with-token/${e.id}`);a.data.url&&(n=`${a.data.url}${t}`),window.open(n,"_blank")}(e,"")},"Open in Valohai"))),Q=()=>{const{configuration:{projectId:e},executionsFetched:t,executions:n,executionEvents:a}=k(),o=C(),r=i.useMemo((()=>new Set(Object.keys(a))),[a]),s=i.useCallback((()=>{e&&async function(e,t){let n={};try{n=await async function(){var e,t;try{const e=await v.get("/executions"),t={};return e.data.results.forEach((e=>{t[e.id]=e})),t}catch(n){if("no_project"===(null===(t=null===(e=n.response)||void 0===e?void 0:e.data.error)||void 0===t?void 0:t.code))return null;throw n}}()}finally{e({type:"executionsFetched"})}if(null===n)return null;Object.values(n).forEach((t=>e({type:"updateExecution",projectId:t.project,execution:t})));const a=(o=n,new Set(Object.keys(o).filter((e=>P(o[e])))));var o,r;(r=n,Object.values(r).sort(((e,t)=>t.counter-e.counter)).slice(0,30)).forEach((n=>{const{id:o}=n;if(!t.has(o)||!a.has(o)){const t=a.has(o)?0:1;!async function(e,t,n){q.add((async()=>{const n=await v.get(`/events/${t}`);e({type:"updateExecutionEvents",id:t,events:n.data.results})}),{priority:n})}(e,o,t)}}))}(o,r)}),[o,r,e]);(0,A.useInterval)(s,t?3e3:50);const c=Object.values(n).sort(((e,t)=>e.counter>t.counter?-1:1)).slice(0,10);return i.createElement("div",{style:{overflow:"auto",color:"var(--jp-ui-font-color0)"}},i.createElement("h2",{style:{padding:"1em"}},"Latest Executions"),i.createElement("table",{style:{paddingLeft:"1em",width:"90%"}},i.createElement("tr",null,i.createElement("th",{style:{textAlign:"left"}},"Counter"),i.createElement("th",{style:{textAlign:"left"}},"Status"),i.createElement("th",{style:{textAlign:"left"}},"Created at"),i.createElement("th",{style:{textAlign:"left"}},"Duration"),i.createElement("th",{style:{textAlign:"left"}},"Actions")),c.map((e=>i.createElement(K,{execution:e})))))};function Y(e){var{className:t}=e,n=function(e,t){var n={};for(var a in e)Object.prototype.hasOwnProperty.call(e,a)&&t.indexOf(a)<0&&(n[a]=e[a]);if(null!=e&&"function"==typeof Object.getOwnPropertySymbols){var o=0;for(a=Object.getOwnPropertySymbols(e);o<a.length;o++)t.indexOf(a[o])<0&&Object.prototype.propertyIsEnumerable.call(e,a[o])&&(n[a[o]]=e[a[o]])}return n}(e,["className"]);return s().createElement("label",Object.assign({},n,{className:X()("control-label",t)}))}function Z(e){var{className:t}=e,n=function(e,t){var n={};for(var a in e)Object.prototype.hasOwnProperty.call(e,a)&&t.indexOf(a)<0&&(n[a]=e[a]);if(null!=e&&"function"==typeof Object.getOwnPropertySymbols){var o=0;for(a=Object.getOwnPropertySymbols(e);o<a.length;o++)t.indexOf(a[o])<0&&Object.prototype.propertyIsEnumerable.call(e,a[o])&&(n[a[o]]=e[a[o]])}return n}(e,["className"]);return s().createElement("input",Object.assign({},n,{className:X()("form-control",t)}))}const ee=({environmentId:e,environments:t,onChange:n})=>{const a=Array.from(t||[]).sort(((e,t)=>e.name<t.name?-1:1)).map((e=>s().createElement("option",{key:e.id,value:e.id},e.name)));let o="undefined";return t?e?o=e:a.unshift(s().createElement("option",{key:"undefined",value:"undefined",disabled:!0},"[Select Environment]")):a.unshift(s().createElement("option",{key:"undefined",value:"undefined",disabled:!0},"[Loading...]")),s().createElement("select",{value:o,className:"form-control jupyhai-select jupyhai-text-field",placeholder:"select",onChange:e=>n(e.target.value)},a)},te=({mount:e,onChange:t,onRemove:n})=>{const a=s().useCallback((n=>{const{name:a}=n.target.dataset;switch(a){case"source":case"destination":t(Object.assign(Object.assign({},e),{[a]:n.target.value}));break;case"readonly":t(Object.assign(Object.assign({},e),{[a]:n.target.checked}))}}),[e,t]);return s().createElement("tr",null,s().createElement("td",{className:"jupyhai-table-cell"},s().createElement(Z,{type:"text",className:"jupyhai-table-text-field",value:e.source,"data-name":"source",onChange:a})),s().createElement("td",{className:"jupyhai-table-cell"},s().createElement(Z,{type:"text",className:"jupyhai-table-text-field",value:e.destination,"data-name":"destination",onChange:a})),s().createElement("td",{className:"jupyhai-table-cell",style:{textAlign:"center",paddingRight:0,width:50}},s().createElement(Z,{type:"checkbox",className:"jupyhai-table-checkbox",checked:e.readonly,"data-name":"readonly",onChange:a})),s().createElement("td",{className:"jupyhai-table-cell",style:{paddingLeft:10,paddingRight:0}},s().createElement("button",{className:"btn",type:"button",onClick:n},s().createElement("i",{className:"fa fa-trash"}))))},ne=({mounts:e,onChange:t})=>{const n=e.map(((n,a)=>s().createElement(te,{mount:n,key:a,onChange:n=>function(n,a){const o=[...e];o[n]=a,t(o)}(a,n),onRemove:()=>function(n){const a=[...e];a.splice(n,1),t(a)}(a)})));return s().createElement(s().Fragment,null,s().createElement("table",{className:"table jupyhai-table"},s().createElement("thead",null,s().createElement("tr",null,s().createElement("th",{className:"jupyhai-table-header"},"Source"),s().createElement("th",{className:"jupyhai-table-header"},"Destination"),s().createElement("th",{className:"jupyhai-table-header"},"Read only"))),s().createElement("tbody",null,n)),s().createElement("a",{onClick:function(){const n=e.concat({destination:"/to/path",source:"/from/path",readonly:!1});t(n)},className:"jupyhai-cursor-pointer"},s().createElement("i",{className:"fa fa-plus"}),"Â Add Mount"))},ae=({projects:e,projectId:t,onChange:n})=>{const a=Array.from(e||[]).sort(((e,t)=>e.name<t.name?-1:1)).map((e=>s().createElement("option",{key:e.id,value:e.id},e.name)));let o="undefined";return e?t?o=t:a.unshift(s().createElement("option",{key:"undefined",value:"undefined",disabled:!0},"[Select Project]")):a.unshift(s().createElement("option",{key:"undefined",value:"undefined",disabled:!0},"[Loading...]")),s().createElement("select",{value:o,className:"form-control jupyhai-select jupyhai-text-field",placeholder:"select",onChange:e=>n(e.target.value)},a)};function oe(){window.open("https://app.valohai.com/projects/create")}function re(e){return e.ignore?e.ignore.filter((e=>e.length>0)):[]}const ie=()=>{var e,t;const[n,a]=i.useState(0),[o,r]=(0,i.useState)(0),{configuration:s,notebookInstanceId:c,hostFlavor:l}=k(),u=C(),d=null===(e=M()("/environments",y).data)||void 0===e?void 0:e.results,g=null===(t=M()("/projects",y).data)||void 0===t?void 0:t.results,p=i.useCallback((e=>{u({type:"changeProject",projectId:e})}),[u]),m=i.useCallback((e=>{u({type:"changeConfiguration",configuration:Object.assign(Object.assign({},s),{environmentId:e})})}),[s,u]),f=i.useCallback((e=>{u({type:"changeConfiguration",configuration:Object.assign(Object.assign({},s),{mounts:e})})}),[s,u]),h=i.useCallback((e=>{u({type:"changeConfiguration",configuration:Object.assign(Object.assign({},s),{image:e})})}),[s,u]),E=i.useCallback((e=>{u({type:"changeConfiguration",configuration:Object.assign(Object.assign({},s),{title:e})})}),[s,u]),b=i.useCallback((async()=>{var e,t,n;const o=await v.get("/prepare",{params:{ignore:JSON.stringify(re(s)),notebook_path:null!==(n=null===(t=null===(e=window.Jupyter)||void 0===e?void 0:e.notebook)||void 0===t?void 0:t.notebook_path)&&void 0!==n?n:"."}});a(o.data.fileCount),r(o.data.totalUncompressedSize)}),[s]),x=i.useCallback((e=>{const t=e.target.value.split("\n");u({type:"changeConfiguration",configuration:Object.assign(Object.assign({},s),{ignore:t})}),b()}),[s,u,b]);i.useEffect((()=>{b()}),[b,u]),i.useEffect((()=>{(!s.projectId||g&&!g.some((e=>e.id===s.projectId)))&&g&&g.length>0&&p(g[0].id),(!s.environmentId||d&&!d.some((e=>e.id===s.environmentId)))&&d&&d.length>0&&m(d[0].id)}),[s,d,g,m,p]);const j=n<0||o<0?i.createElement("p",{className:"text-danger jupyhai-sizeinfo"},"Warning: Execution will be too large! Try ignoring files or change your root folder."):i.createElement("p",{className:"text-muted jupyhai-sizeinfo"},n," files, ",L()(o));let w=i.createElement(ae,{projectId:void 0,projects:void 0,onChange:p,onNewProject:oe});if(g){const e=g.find((e=>e.id===s.projectId));w=c?i.createElement("div",null,i.createElement(Z,{className:"jupyhai-text-field",value:e?e.name:"Set by notebook",disabled:!0})):i.createElement(ae,{projectId:e?e.id:void 0,projects:g,onChange:p,onNewProject:oe})}return i.createElement("form",{className:"form jupyhai-form"},i.createElement("div",{className:"form-group"},"minihai"!==l&&i.createElement(i.Fragment,null,i.createElement(Y,null,"Project"),w,i.createElement(Y,null,"Environment"),i.createElement(ee,{environmentId:s.environmentId,environments:d||void 0,onChange:m})),i.createElement(Y,null,"Docker Image"),i.createElement(Z,{type:"text",className:"jupyhai-text-field",value:s.image,onChange:e=>h(e.target.value)}),i.createElement(Y,null,"Ignore"),i.createElement("textarea",{className:"form-control jupyhai-text-field",value:s.ignore?s.ignore.join("\n"):"",onChange:x}),j,"minihai"!==l&&i.createElement(i.Fragment,null,i.createElement(Y,null,"Title"),i.createElement(Z,{type:"text",className:"jupyhai-text-field",value:s.title,onChange:e=>E(e.target.value)})),i.createElement(Y,null,"Mounts"),i.createElement(ne,{mounts:s.mounts||[],onChange:f})))};var se=n(4439);const ce=({flavor:e,onLogin:t})=>{const n=C(),{loginStatus:a,loginError:o,defaultHost:r}=k(),[s,c]=(0,i.useState)(""),[l,u]=(0,i.useState)(""),[d,g]=(0,i.useState)((()=>"minihai"===e?"":r||"")),[p,m]=(0,i.useState)(""),[f,h]=(0,i.useState)(!1),y=i.useCallback((async a=>{let o;if(a.preventDefault(),p&&"valohai"===e)o=await async function(e,t){return(await v.post("/login",{token:e,hostUrl:t})).data}(p,d);else{if(!s||!l)return;o=await async function(e,t,n){return(await v.post("/login",{username:e,password:t,hostUrl:n})).data}(s,l,d)}o.success?(n({type:"loginSuccess",hostFlavor:e,username:s}),t()):(n({type:"loginFailed",error:o.error||void 0}),h(!0))}),[e,n,t,l,p,s,d]),b=i.useCallback((e=>{switch(e.target.name){case"username":c(e.target.value);break;case"password":u(e.target.value);break;case"token":m(e.target.value);break;case"hostUrl":g(e.target.value)}e.stopPropagation()}),[]);return i.createElement("form",{className:"form jupyhai-form",style:{padding:"15px"}},i.createElement("div",{style:{border:"1px solid lightgray",padding:"12px"}},i.createElement(Y,null,"Username"),i.createElement(Z,{type:"text",name:"username",className:"jupyhai-text-field",autoFocus:!0,value:s,placeholder:"minihai"===e?"sharky":"",onChange:b}),i.createElement(Y,null,"Password"),i.createElement(Z,{type:"password",name:"password",className:"jupyhai-text-field",value:l,placeholder:"minihai"===e?"12345":"",onChange:b}),i.createElement("p",{style:{textAlign:"center",width:"100%"}},"or"),i.createElement(Y,null,"API Token"),i.createElement(Z,{type:"text",name:"token",className:"jupyhai-text-field",value:p,disabled:"minihai"===e,onChange:b})),i.createElement("div",{style:{padding:"12px"}},i.createElement(Y,null,"Host URL"),i.createElement(Z,{type:"text",name:"hostUrl",className:"jupyhai-text-field",value:d,onChange:b}),f&&i.createElement("div",{className:"alert alert-danger"},o||"Login has failed for an unknown reason."),i.createElement("button",{onClick:y,type:"submit",className:"btn btn-default jupyhai-button"},"Login"),i.createElement(W,{visible:a===E.LoggingIn}),i.createElement("a",{className:"jupyhai-login-info"},"What is ",(0,se.capitalize)(e),"?")))},le=({loginStatus:e,username:t})=>{const n=C(),a=i.useCallback((async()=>{await v.post("/logout"),n({type:"logout"})}),[n]);return e===E.LoggedIn?i.createElement("div",{style:{padding:"2em"}},"ðŸ‘‹",t?i.createElement(i.Fragment,null," ","Hello, ",i.createElement("b",null,t),"!"):i.createElement(i.Fragment,null," Hello!"),i.createElement("button",{className:"jupyhai-button",type:"button",style:{marginLeft:"1em"},onClick:a},"Log out")):i.createElement(ce,{onLogin:()=>console.log("Logged in"),flavor:"valohai"})},ue=()=>{const{loginStatus:e,username:t}=k();return i.createElement("div",{style:{color:"var(--jp-ui-font-color0)"}},i.createElement("h2",{style:{padding:"1em"}},"Valohai Settings"),i.createElement(le,{loginStatus:e,username:t}),e===E.LoggedIn&&i.createElement(ie,null))},de="valohai:settings",ge="valohai:executions",pe="valohai:runremote";class me{constructor(e,t){this.attemptingExecution=!1,this.openExecutionsView=()=>{this.activateOrCreatePanelWithComponent("valohai-executions","Valohai Executions",i.createElement(Q,null))},this.openSettingsPanel=()=>{this.activateOrCreatePanelWithComponent("valohai-settings","Valohai Settings",i.createElement(ue,null))},this.openLogPanel=(e,t)=>{this.activateOrCreatePanelWithComponent(`valohai-log-${e}`,`Valohai Execution #${t}`,i.createElement(T,{executionId:e}),"down")},this.openLogs=e=>{e.detail&&this.openLogPanel(e.detail.id,e.detail.counter)},this.addPreparingExecutionEvent=(e,t,n)=>{w({type:"addPreparingExecutionEvent",event:{message:e,time:(new Date).toTimeString(),stream:t,tags:n}})},this.executeCallback=async e=>{if(this.attemptingExecution)return;const{configuration:{image:t,projectId:n},executions:a,loginStatus:o}=O.get();if(o===E.LoggedIn&&n&&t)try{this.attemptingExecution=!0,w({type:"startPreparingExecution",currentMaxCounter:F(a)}),await async function(e,t){var n,a,o;try{if(e("Saving notebook..."),window.Jupyter&&window.Jupyter.notebook)await window.Jupyter.notebook.save_checkpoint();else{if(!t)throw Error("Missing jupyter lab details");t.save()}e("Done.");const{notebookPath:n,notebookJSON:a}=function(e){if(window.Jupyter)return{notebookPath:window.Jupyter.notebook.notebook_path,notebookJSON:window.Jupyter.notebook.toJSON()};if(e)return{notebookPath:e.path,notebookJSON:e.json};throw new Error("Can't get notebook data")}(t),o={type:"notebook",content:a};e("Calculating Valohai execution package size...");const r=await v.get("/prepare",{params:{notebook_path:n}}),{fileCount:i,totalUncompressedSize:s}=r.data;if(!(i>-1))throw e("Trying to package too many files! Execution aborted.","stderr",void 0),e("Do NOT start the notebook server from a large folder like home (~/).","stderr",void 0),e("Use the settings window to ignore files to make the package smaller.","stderr",void 0),new Error("Trying to package too many files.");e(`Package size: ${i} files, ${L()(s)}`),e("Preparing Valohai execution package...");const c=await v.post("/prepare",{path:n,content:o}),{commit:l}=c.data;e(`Creating execution with ${l}...`);const u=await v.post("/execute",{commit:l,content:o}),{execution:d}=u.data;t&&function(e,t){const n=new CustomEvent(S.ShowLogs,{detail:{id:e,counter:t}});window.dispatchEvent(n)}(d.id,d.counter),e(`Done â€“ ${d.id}`)}catch(t){throw e(`FAILED: ${(null===(o=null===(a=null===(n=t.response)||void 0===n?void 0:n.data)||void 0===a?void 0:a.error)||void 0===o?void 0:o.message)||t}`,"stderr",void 0),console.error(t),t}}(this.addPreparingExecutionEvent,e)}catch(e){w({type:"preparingExecutionFailed"})}finally{this.attemptingExecution=!1}else N(S.ShowSettings)},this.app=e,this.mainMenu=t}activateOrCreatePanelWithComponent(e,t,n,a="main"){if(document.getElementById(e))return void this.app.shell.activateById(e);const i=function(e,t){const n=new r.Widget,a=new o.MainAreaWidget({content:n});return a.id=e,a.title.label=t,a.title.closable=!0,{page:a,content:n}}(e,t);c.render(n,i.content.node),function(e,t,n="main"){const a=t.page;a.isAttached||e.shell.add(a,n),e.shell.activateById(a.id)}(this.app,i,a)}configureCommands(){const{app:e}=this;e.docRegistry.addWidgetExtension("Notebook",new H),e.contextMenu.addItem({command:pe,selector:".jp-Notebook"}),e.commands.addCommand(ge,{label:"Valohai Executions",execute:this.openExecutionsView}),e.commands.addCommand(de,{label:"Valohai Settings",execute:this.openSettingsPanel}),e.commands.addCommand(pe,{label:"Valohai Run Remote",execute:()=>N(S.Execute)})}configureMainMenu(){const{mainMenu:e}=this;e.settingsMenu.addGroup([{command:de}],2),e.viewMenu.addGroup([{command:ge},{command:"valohai:logs"}],2)}async boot(){h.defaults.headers.common["X-Jupyhai-Frontend"]="jupyterlab",await async function(){try{const e=await async function(){return y("/hello")}();return console.log("Jupyhai hello response:",e),!0}catch(e){return console.error("Jupyhai hello failed:",e),!1}}()&&(this.configureCommands(),this.configureMainMenu(),this.configureEventListeners(),await async function(e){const t=await async function(){const e=await v.get("/login"),{logged_in:t,notebook_instance_id:n,username:a,host_flavor:o,default_host:r}=e.data,i=await v.get("/settings"),{environment:s,project:c,image:l,title:u,ignore:d,mounts:g}=i.data.result;return{loginStatus:t?E.LoggedIn:E.LoggedOut,notebookInstanceId:n,hostFlavor:o,defaultHost:r,username:a,configuration:{projectId:c,environmentId:s,image:l,title:u,ignore:d,mounts:g}}}();t&&e({type:"loadPersistedState",persistedState:t})}(w),console.log("JupyterLab extension jupyhai is activated!"))}configureEventListeners(){window.addEventListener(S.ShowSettings,this.openSettingsPanel),window.addEventListener(S.Execute,this.openExecutionsView),window.addEventListener(S.ShowLogs,(e=>{(function(e){return e.type===S.ShowLogs})(e)&&this.openLogs(e)})),window.addEventListener(S.Execute,(e=>{(function(e){return e.type===S.Execute})(e)&&this.executeCallback(e.detail)}))}}const fe={id:"jupyhai:plugin",autoStart:!0,requires:[a.IMainMenu],activate:(e,t)=>{new me(e,t).boot()}}},2705:(e,t,n)=>{var a=n(5639).Symbol;e.exports=a},9932:e=>{e.exports=function(e,t){for(var n=-1,a=null==e?0:e.length,o=Array(a);++n<a;)o[n]=t(e[n],n,e);return o}},4286:e=>{e.exports=function(e){return e.split("")}},4239:(e,t,n)=>{var a=n(2705),o=n(9607),r=n(2333),i=a?a.toStringTag:void 0;e.exports=function(e){return null==e?void 0===e?"[object Undefined]":"[object Null]":i&&i in Object(e)?o(e):r(e)}},4259:e=>{e.exports=function(e,t,n){var a=-1,o=e.length;t<0&&(t=-t>o?0:o+t),(n=n>o?o:n)<0&&(n+=o),o=t>n?0:n-t>>>0,t>>>=0;for(var r=Array(o);++a<o;)r[a]=e[a+t];return r}},531:(e,t,n)=>{var a=n(2705),o=n(9932),r=n(1469),i=n(3448),s=a?a.prototype:void 0,c=s?s.toString:void 0;e.exports=function e(t){if("string"==typeof t)return t;if(r(t))return o(t,e)+"";if(i(t))return c?c.call(t):"";var n=t+"";return"0"==n&&1/t==-1/0?"-0":n}},180:(e,t,n)=>{var a=n(4259);e.exports=function(e,t,n){var o=e.length;return n=void 0===n?o:n,!t&&n>=o?e:a(e,t,n)}},8805:(e,t,n)=>{var a=n(180),o=n(2689),r=n(3140),i=n(9833);e.exports=function(e){return function(t){t=i(t);var n=o(t)?r(t):void 0,s=n?n[0]:t.charAt(0),c=n?a(n,1).join(""):t.slice(1);return s[e]()+c}}},1957:(e,t,n)=>{var a="object"==typeof n.g&&n.g&&n.g.Object===Object&&n.g;e.exports=a},9607:(e,t,n)=>{var a=n(2705),o=Object.prototype,r=o.hasOwnProperty,i=o.toString,s=a?a.toStringTag:void 0;e.exports=function(e){var t=r.call(e,s),n=e[s];try{e[s]=void 0;var a=!0}catch(e){}var o=i.call(e);return a&&(t?e[s]=n:delete e[s]),o}},2689:e=>{var t=RegExp("[\\u200d\\ud800-\\udfff\\u0300-\\u036f\\ufe20-\\ufe2f\\u20d0-\\u20ff\\ufe0e\\ufe0f]");e.exports=function(e){return t.test(e)}},2333:e=>{var t=Object.prototype.toString;e.exports=function(e){return t.call(e)}},5639:(e,t,n)=>{var a=n(1957),o="object"==typeof self&&self&&self.Object===Object&&self,r=a||o||Function("return this")();e.exports=r},3140:(e,t,n)=>{var a=n(4286),o=n(2689),r=n(676);e.exports=function(e){return o(e)?r(e):a(e)}},676:e=>{var t="[\\u0300-\\u036f\\ufe20-\\ufe2f\\u20d0-\\u20ff]",n="\\ud83c[\\udffb-\\udfff]",a="[^\\ud800-\\udfff]",o="(?:\\ud83c[\\udde6-\\uddff]){2}",r="[\\ud800-\\udbff][\\udc00-\\udfff]",i="(?:"+t+"|"+n+")?",s="[\\ufe0e\\ufe0f]?",c=s+i+"(?:\\u200d(?:"+[a,o,r].join("|")+")"+s+i+")*",l="(?:"+[a+t+"?",t,o,r,"[\\ud800-\\udfff]"].join("|")+")",u=RegExp(n+"(?="+n+")|"+l+c,"g");e.exports=function(e){return e.match(u)||[]}},1469:e=>{var t=Array.isArray;e.exports=t},7005:e=>{e.exports=function(e){return null!=e&&"object"==typeof e}},3448:(e,t,n)=>{var a=n(4239),o=n(7005);e.exports=function(e){return"symbol"==typeof e||o(e)&&"[object Symbol]"==a(e)}},9833:(e,t,n)=>{var a=n(531);e.exports=function(e){return null==e?"":a(e)}},1700:(e,t,n)=>{var a=n(8805)("toUpperCase");e.exports=a}}]);